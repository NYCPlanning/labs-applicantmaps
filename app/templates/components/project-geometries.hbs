<div class="cell sidebar map-sidebar">
  {{!-- EMBER WORMHOLE CONTAINER --}}
  {{!-- The geometry type component will fill this div with markup once invoked --}}
  <div id="geometry-type-draw-explainer">
  </div>

  {{!-- EMBER WORMHOLE CONTAINER --}}
  <div id="geometry-type-save-box">
  </div>

</div>
<div class="cell large-auto map-container">
  {{#if layerGroups}}
    {{#labs-map
      id='main-map'
      initOptions=(hash
        style=layerGroups.meta.mapboxStyle
        zoom=12
        center=(array -73.983307 40.704977)
        pitchWithRotate=false
      )
      mapLoaded=(action 'handleMapLoad') as |map|}}

      {{#mapbox-gl-draw map=map as |drawableMap|}}
        {{search-handler
          map=map}}

        {{!-- labs-layers (includes tax-lots layer) --}}
        {{#map.labs-layers
          layerGroups=layerGroups.layerGroups
          as |layers|}}
          {{#layers.tooltip as |tooltip|}}
            {{tooltip-renderer
              feature=tooltip.feature
              template=tooltip.layer.tooltipTemplate}}
          {{/layers.tooltip}}
        {{/map.labs-layers}}

        {{!-- Annotations here --}}
        {{!-- we need a separate component to render annotations --}}

        {{#map.source options=(mapbox-geojson-source model.developmentSite) as |source|}}
          {{source.layer
            layer=developmentSiteLayer
            before='boundary_country'
          }}
        {{/map.source}}

        {{#map.source options=(mapbox-geojson-source model.projectArea) as |source|}}
          {{source.layer
            layer=projectAreaLayer
            before='boundary_country'
          }}
        {{/map.source}}

        {{!-- labs-layers (includes tax-lots layer) --}}
        {{#map.labs-layers
          layerGroups=layerGroups.layerGroups
          as |layers|}}
          {{#layers.tooltip as |tooltip|}}
            {{tooltip-renderer
              feature=tooltip.feature
              template=tooltip.layer.tooltipTemplate}}
          {{/layers.tooltip}}
        {{/map.labs-layers}}

        {{!-- invoke the component for the specified type --}}
        {{component projectGeometryType
          model=geometricPropertyForType
          mode=mode
          map=drawableMap}}

        {{!-- transport this markup when map is done loading --}}
        {{#ember-wormhole to='geometry-type-save-box'}}
          <div class="stable">
            {{#if (eq mode 'lots')}}
              {{#link-to 'projects.edit.geometry-edit' model.id (query-params mode='draw')
                tagName='button'
                class='button gray expanded'
                disabled=(not model.hasDirtyAttributes)
              }}
                Switch to Manual Drawing
                <small style="display:block;line-height:1.75;">
                  (edit the shape with draw tools)
                </small>
              {{/link-to}}
            {{/if}}
          </div>
        {{/ember-wormhole}}
      {{/mapbox-gl-draw}}
    {{/labs-map}}
  {{/if}}
  {{#if
    (or
      (not (is-empty model.developmentSite))
      (not (is-empty model.projectArea))
      (not (is-empty model.underlyingZoning))
      (not (is-empty model.specialPurposeDistricts))
      (not (is-empty model.rezoningArea))
    )
  }}
    <ul class="over-map-legend no-bullet">
      {{#if (not (is-empty model.developmentSite))}}
        <li><strong>Development Site</strong> {{labs-ui/legend-icon icon=projectGeometryIcons.developmentSiteIcon}}</li>
      {{/if}}
      {{#if (not (is-empty model.projectArea))}}
        <li><strong>Project Area</strong> {{labs-ui/legend-icon icon=projectGeometryIcons.projectAreaIcon}}</li>
      {{/if}}
      {{#if (not (is-empty model.underlyingZoning))}}
        <li><strong>Underlying Zoning</strong> {{labs-ui/legend-icon icon=projectGeometryIcons.underlyingZoningIcon}}</li>
      {{/if}}
      {{#if (not (is-empty model.specialPurposeDistricts))}}
        <li><strong>Special Purpose Districts</strong> {{labs-ui/legend-icon icon=projectGeometryIcons.specialPurposeDistrictsIcon}}</li>
      {{/if}}
      {{#if (not (is-empty model.rezoningArea))}}
        <li><strong>Rezoning Area</strong> {{labs-ui/legend-icon icon=projectGeometryIcons.rezoningAreaIcon}}</li>
      {{/if}}
    </ul>
  {{/if}}
</div>
